<!DOCTYPE html>
<html>
<head>
  <title>Fingerprint Attendance</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>Fingerprint Attendance</h1>
  
  <input type="text" id="studentName" placeholder="Enter Name for Registration">
  <button onclick="registerStudent()">Register with Fingerprint</button>
  
  <hr>
  
  <button onclick="markAttendance()">Scan Fingerprint & Mark Attendance</button>
  <p id="result"></p>

  <script>
    async function registerStudent() {
      let name = document.getElementById("studentName").value;
      if (!name) return alert("Enter a name!");

      try {
        // WebAuthn registration
        const credential = await navigator.credentials.create({
          publicKey: {
            challenge: new Uint8Array(32),
            rp: { name: "Attendance System" },
            user: {
              id: new Uint8Array(16),
              name: name,
              displayName: name
            },
            pubKeyCredParams: [{ alg: -7, type: "public-key" }],
            authenticatorSelection: { userVerification: "required" }
          }
        });

        let credential_id = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));

        let res = await fetch("/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, credential_id })
        });

        let data = await res.json();
        alert(data.message);
        localStorage.setItem("credential_id", credential_id);

      } catch (err) {
        alert("Registration failed: " + err);
      }
    }

    async function markAttendance() {
      try {
        // WebAuthn authentication
        const assertion = await navigator.credentials.get({
          publicKey: {
            challenge: new Uint8Array(32),
            userVerification: "required"
          }
        });

        let credential_id = btoa(String.fromCharCode(...new Uint8Array(assertion.rawId)));

        let res = await fetch("/mark_attendance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ credential_id })
        });

        let data = await res.json();
        document.getElementById("result").innerText = data.message;

      } catch (err) {
        document.getElementById("result").innerText = "Authentication failed: " + err;
      }
    }
  </script>
</body>
</html>
